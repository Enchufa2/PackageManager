#!/bin/sh

. inst/service/dbus-paths

subst() {
  DIR=$(pwd)
  cd $1 && cat $2 |
    sed "s @BUS_NAME@ $BUS_NAME g" |
    sed "s @R_LIBRARY_DIR@ ${R_LIBRARY_DIR#"$BUILD_ROOT"} g" > $3
  cd $DIR
}

if [ -z "$PKG_PREFIX" ]; then
  echo "Error: PKG_PREFIX required"
  exit 1
fi
echo "PREFIX='$PKG_PREFIX'" >> inst/service/bspm.conf

if [ "$1" != "--with-dbus-service" ]; then
  echo "Warning: the D-BUS service won't be installed"
else
  mkdir -p $BUILD_ROOT/usr/share/dbus-1/system-services
  mkdir -p $BUILD_ROOT/etc/dbus-1/system.d
  subst inst/service dbus.service.in $BUILD_ROOT/usr/share/dbus-1/system-services/$BUS_NAME.service
  subst inst/service dbus.conf.in $BUILD_ROOT/etc/dbus-1/system.d/$BUS_NAME.conf
fi
